# Draw cumulative proportion of number of meta-clusters generated by each
# TrackSOM solutions
library(data.table)

operations <- c("with_merge", "no_merge")
options <- c("AA", "PI", "PV")

metas_count <- lapply(operations, function(op) {
    metas_count <- lapply(c(1:3), function(j) {
        metas_count <- lapply(c(0:99), function(m) {
            setwd(paste0("M:/givanna/tsom/", op, "/option_", j, "/", m))
            num_metas <- sapply(c(0:7), function(i) {
                dat <- fread(paste0("Result_FileName_WNV_D", i, ".csv"))
                n_meta <-
                    length(unique(dat$TrackSOM_metacluster_lineage_tracking))
                return(n_meta)
            })
            num_metas <- sum(num_metas)
            num_metas_dt <- data.table(
                param_idx = m,
                operation = options[j],
                merge = op,
                num_meta = num_metas
            )
            return(num_metas_dt)
        })
        metas_count <- rbindlist(metas_count)
        return(metas_count)
    })
    metas_count <- rbindlist(metas_count)
    return(metas_count)
})
metas_count_dt <- rbindlist(metas_count)

setwd("M:/givanna/tsom")
fwrite(metas_count_dt, "count_meta_bm.csv")

setwd("~/Documents/phd/tracksom/")
count_dat <- fread("count_meta_bm.csv")

# remove duplicated parameters
lhc_samples <-
    read.files(
        "~/Documents/GitHub/FlowSOM-tracking/experiment_materials/wnv_bm_dataset/lhc_samples"
    )
lhc_tracksom <- lhc_samples[['TrackSOM_lhc']]
cols <- names(lhc_tracksom)[1:10]
lhc_tracksom[, (cols) := round(.SD), .SDcols = cols]

# find duplicates based on just max meta and grid size (for aa and pi mode)
lhc_tracksom$dup_for_AA_PI <-
    duplicated(lhc_tracksom, by = names(lhc_tracksom)[c(1, 10)])
lhc_tracksom$dup_for_PV <-
    duplicated(lhc_tracksom, by = names(lhc_tracksom)[c(2:10)])

dup_aa_pi <-
    lhc_tracksom[lhc_tracksom$dup_for_AA_PI == TRUE, ]$parameter
dup_pv <-
    lhc_tracksom[lhc_tracksom$dup_for_PV == TRUE, ]$parameter # this is nothing! good!

count_dat <- count_dat[!(count_dat$param_idx %in% dup_aa_pi &
                             count_dat$operation %in% c("AA", "PI")), ]
count_dat[, op_and_merge := paste0(operation, "_", merge)]

modes <- c(
    "AA_no_merge",
    "PI_no_merge",
    "PV_no_merge",
    "AA_with_merge",
    "PI_with_merge",
    "PV_with_merge"
)
modes_name <-
    c(
        "No Merging Autonomous Adaptive",
        "No Merging Prescribed Invariant",
        "No Merging Prescribed Variant",
        "Merging Autonomous Adaptive",
        "Merging Prescribed Invariant",
        "Merging Prescribed Variant"
    )

library(ggplot2)
df.plt <- ggplot(count_dat, aes(num_meta, colour = op_and_merge)) +
    stat_ecdf(geom = "step", size = 1) +
    labs(x = "Total number of meta-clusters for all days", y = "Cumulative Proportion") +
    scale_color_manual(
        breaks = modes,
        values = c(
            "#4b9c7a",
            "#ca6628",
            "#7470af",
            "#7ec0a6",
            "#ed926b",
            "#929fc7"
        ),
        labels = modes_name,
        name = "Mode of operation"
    ) +
    scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
    guides(colour = guide_legend(override.aes = list(size = 3),
                                 ncol = 2)) +
    ggtitle("Cumulative proportion of total number of meta-clusters") +
    theme_bw() +
    theme(
        text = element_text(size = 10),
        legend.position = 'bottom',
        rect = element_rect(size = 1),
        panel.grid.minor = element_line(size = 1),
        panel.grid.major = element_line(size = 1)
    )
# df.plt
ggsave(
    filename = "ecdf_meta_count.png",
    plot = df.plt,
    dpi = 1200,
    width = 150,
    height = 100,
    unit = 'mm'
)
